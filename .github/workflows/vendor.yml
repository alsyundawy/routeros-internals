name: Vendor RouterOS 7.x Internals Workflow
on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  BRANCH_HOST: 'download.mikrotik.com'
  BRANCH_PREFIX: 'vendor'
  BRANCH_VERSION: ${{ secrets.VENDOR_BRANCH_VERSION }}

jobs:
  Download_Files:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        channel: [ stable ]
        #channel: [ stable, testing ]
    env:
      TZ: 'Europe/London'
    steps:
      - name: Get the latest version
        run: |
          if [[ -z "${{ env.BRANCH_VERSION }}" ]]; then
            BRANCH_VERSION_URL="https://${{ env.BRANCH_HOST }}/routeros/NEWESTa7.${{ matrix.channel }}"
            echo "BRANCH_VERSION_URL=${BRANCH_VERSION_URL}"
            BRANCH_VERSION=$(wget -nv -O - ${BRANCH_VERSION_URL} | cut -d ' ' -f1)
            echo "BRANCH_VERSION=${BRANCH_VERSION}"
          fi
          echo "BRANCH_VERSION=${BRANCH_VERSION}" >> $GITHUB_ENV

      - name: Cache files
        id: cache-files
        uses: actions/cache@v4
        with:
          key: ${{ env.BRANCH_PREFIX }}-${{ matrix.channel }}-${{ env.BRANCH_VERSION }}
          lookup-only: true
          path: |
            changelog.txt
            arm64
            x86

      - name: Get a changelog
        if: steps.cache-files.outputs.cache-hit != 'true'
        run: |
          BRANCH_CHANGELOG_URL="https://${{ env.BRANCH_HOST }}/routeros/${BRANCH_VERSION}/CHANGELOG"
          echo "BRANCH_CHANGELOG_URL=${BRANCH_CHANGELOG_URL}"
          wget -nv -O changelog.txt ${BRANCH_CHANGELOG_URL}

      - name: Download files
        if: steps.cache-files.outputs.cache-hit != 'true'
        run: |
          ARHCS=(arm64 x86)
          PACKAGES=(routeros calea container dude extra-nic gps iot iot-bt-extra lora rose-storage switch-marvell tr069-client ups user-manager wifi-qcom wireless zerotier)
          for ARCH in ${ARHCS[@]}; do
            mkdir -p ${ARCH}
            if [ "${ARCH}" == 'x86' ]; then
              SUFFIX=''
            else
              SUFFIX="-${ARCH}"
            fi
            IMG_FILE="${ARCH}/chr-${BRANCH_VERSION}${SUFFIX}.img.zip"
            IMG_URL="https://${{ env.BRANCH_HOST }}/routeros/${BRANCH_VERSION}/chr-${BRANCH_VERSION}${SUFFIX}.img.zip"
            wget -nv -O ${IMG_FILE} ${IMG_URL} || rm -f ${IMG_FILE}
            ISO_FILE="${ARCH}/mikrotik-${BRANCH_VERSION}${SUFFIX}.iso"
            ISO_URL="https://${{ env.BRANCH_HOST }}/routeros/${BRANCH_VERSION}/mikrotik-${BRANCH_VERSION}${SUFFIX}.iso"
            wget -nv -O ${ISO_FILE} ${ISO_URL} || rm -f ${ISO_FILE}
            for PACKAGE in ${PACKAGES[@]}; do
              FILE="${ARCH}/${PACKAGE}-${BRANCH_VERSION}${SUFFIX}.npk"
              URL="https://${{ env.BRANCH_HOST }}/routeros/${BRANCH_VERSION}/${PACKAGE}-${BRANCH_VERSION}${SUFFIX}.npk"
              wget -nv -O ${FILE} ${URL} || rm -f ${FILE}
            done
          done

  Obtain_Internals:
    needs: Download_Files
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        channel: [ stable ]
        #channel: [ stable, testing ]
    env:
      TZ: 'Europe/London'
    steps:
      - name: Install requirements leveraging cache
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          execute_install_scripts: true
          packages: binutils-common binwalk bzip2 genisoimage gzip lz4 lzma lzop rsync xz-utils zip zstd
          version: 1.0

      #- name: Install requirements
      #  run: |
      #    echo $(uname -a)
      #    sudo apt update > /dev/null
      #    sudo apt install -y binutils-common binwalk bzip2 genisoimage gzip lz4 lzma lzop rsync xz-utils zip zstd
      #    #sudo apt install -y dosfstools extlinux mkisofs qemu-utils xorriso > /dev/null
      #    #sudo modprobe nbd > /dev/null

      #- name: Install Python
      #  uses: actions/setup-python@v5
      #  with:
      #    python-version: '3.11'

      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Prepare scripts
        run: |
          wget -nv -O /tmp/extract-vmlinux.sh "https://raw.githubusercontent.com/torvalds/linux/master/scripts/extract-vmlinux" || true
          cp -r ./MikroTikPatch /tmp/
          cp ./*.py /tmp/
          cp ./*.sh /tmp/
          chmod +x /tmp/*.sh        

      - name: Get the latest version
        run: |
          if [[ -z "${{ env.BRANCH_VERSION }}" ]]; then
            BRANCH_VERSION_URL="https://${{ env.BRANCH_HOST }}/routeros/NEWESTa7.${{ matrix.channel }}"
            echo "BRANCH_VERSION_URL=${BRANCH_VERSION_URL}"
            BRANCH_VERSION=$(wget -nv -O - ${BRANCH_VERSION_URL} | cut -d ' ' -f1)
            echo "BRANCH_VERSION=${BRANCH_VERSION}"
          fi
          echo "BRANCH_VERSION=${BRANCH_VERSION}" >> $GITHUB_ENV

      - name: Prepare an empty branch
        run: |
          BRANCH_NAME="${{ env.BRANCH_PREFIX }}-${{ matrix.channel }}-${{ env.BRANCH_VERSION }}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          git switch --orphan ${BRANCH_NAME}

      - name: Cache files
        id: cache-files
        uses: actions/cache@v4
        with:
          key: ${{ env.BRANCH_PREFIX }}-${{ matrix.channel }}-${{ env.BRANCH_VERSION }}
          path: |
            changelog.txt
            arm64
            x86

      - name: Unpack ISO files
        run: |
          FILES=($(find */* -maxdepth 1 -type f -name '*.iso'))
          declare -A HASHES
          for FILE in ${FILES}; do
            HASH="$(sha256sum "${FILE}" | gawk '{ print $1 }')"
            if [ -n "${HASHES[${HASH}]}" ]; then
              ln -sfr "${HASHES[${HASH}]}" "${FILE}"
            else
              HASHES[${HASH}]="$(realpath "${FILE}")"
              echo -e "${HASH} ${FILE}" >> 'hashes.txt'
              /tmp/unpack.sh "${FILE}" || true
            
              README="$(dirname ${FILE})/_$(basename ${FILE})/README.md"
              echo -e "#### Notes:\n- Some NPK files are replaced with symlinks to save space, if their SHA256 hashes match those of NPK files downloaded separately.\n" >> "${README}"
            fi
          done

      - name: Unpack IMG files
        run: |
          FILES=($(find */_*.iso/* -maxdepth 1 -type f -name '*.img'))
          declare -A HASHES
          for FILE in ${FILES}; do
            HASH="$(sha256sum "${FILE}" | gawk '{ print $1 }')"
            if [ -n "${HASHES[${HASH}]}" ]; then
              ln -sfr "${HASHES[${HASH}]}" "${FILE}"
            else
              HASHES[${HASH}]="$(realpath "${FILE}")"
              echo -e "${HASH} ${FILE}" >> 'hashes.txt'
              /tmp/unpack.sh "${FILE}" || true
            fi
          done

      - name: Unpack NPK files
        run: |
          FILES=($(
            find */* -maxdepth 1 -type f -name '*.npk'
            find */*.iso/* -maxdepth 1 -type f -name '*.npk'
          ))
          echo -e "${FILES}"
          declare -A HASHES
          for FILE in ${FILES}; do
            HASH="$(sha256sum "${FILE}" | gawk '{ print $1 }')"
            if [ -n "${HASHES[${HASH}]}" ]; then
              ln -sfr "${HASHES[${HASH}]}" "${FILE}"
            else
              HASHES[${HASH}]="$(realpath "${FILE}")"
              echo -e "${HASH} ${FILE}" >> 'hashes.txt'
              python /tmp/unpack-npk.py "${FILE}" || true
            fi
          done

      - name: Unpack SFS files
        run: |
          FILES=($(
            find */_*.npk/* -maxdepth 1 -type f -name '*.sfs'
            find */_*.iso/_*.npk/* -maxdepth 1 -type f -name '*.sfs'
          ))
          declare -A HASHES
          for FILE in ${FILES}; do
            HASH="$(sha256sum "${FILE}" | gawk '{ print $1 }')"
            if [ -n "${HASHES[${HASH}]}" ]; then
              ln -sfr "${HASHES[${HASH}]}" "${FILE}"
            else
              HASHES[${HASH}]="$(realpath "${FILE}")"
              echo -e "${HASH} ${FILE}" >> 'hashes.txt'
              unsquashfs -d "$(dirname "${FILE}")/_$(basename "${FILE}")" "${FILE}" || true
            fi
          done

      - name: Unpack bzImage files
        run: |
          FILES=($(
            find x86/_*.npk/*.files/boot/EFI/BOOT/* -maxdepth 1 -type f -name "*.EFI" 2>/dev/null || true
            find x86/_*.npk/_*.sfs/boot/EFI/BOOT/* -maxdepth 1 -type f -name "*.EFI" 2>/dev/null || true
            find x86/_*.iso/_*.img/* -maxdepth 1 -type f -name "linux.*" 2>/dev/null || true
            find x86/_*.iso/_*.npk/*.files/boot/EFI/BOOT/* -maxdepth 1 -type f -name "*.EFI" 2>/dev/null || true
            find x86/_*.iso/_*.npk/_*.sfs/boot/EFI/BOOT/* -maxdepth 1 -type f -name "*.EFI" 2>/dev/null || true
          ))
          echo -e "${FILES}"
          declare -A HASHES
          for FILE in ${FILES}; do
            HASH="$(sha256sum "${FILE}" | gawk '{ print $1 }')"
            if [ -n "${HASHES[${HASH}]}" ]; then
              ln -sfr "${HASHES[${HASH}]}" "${FILE}"
            else
              HASHES[${HASH}]="$(realpath "${FILE}")"
              echo -e "${HASH} ${FILE}" >> 'hashes.txt'
              /tmp/unpack.sh "${FILE}" || true
            fi
          done

#      - name: Unpack EFI files
#        run: |
#          FILES_1=$(find */_*.iso/_*.img/* -maxdepth 4 -type f -path "*/_*.iso/_*.img/boot/EFI/BOOT/*.EFI") # arm64, x86
#          FILES_2=$(find */_*.iso/_*.img/* -maxdepth 1 -type f -name "linux.*") # x86
#          FILES_3=$(find */_*.npk/*.files/* -maxdepth 2 -type f -path "*/_*.npk/*.files/boot/kernel") # arm64
#          FILES_4=$(find */_*.npk/*.files/* -maxdepth 4 -type f -path "*/_*.npk/*.files/boot/EFI/BOOT/*.EFI") # x86
#          FILES_5=$(find */_*.npk/_*.sfs/* -maxdepth 4 -type f -path "*/_*.npk/_*.sfs/boot/EFI/BOOT/*.EFI") # arm64, x86
#          FILES=("${FILES_1[@]}" "${FILES_2[@]}" "${FILES_3[@]}" "${FILES_4[@]}" "${FILES_5}[@])")
#          for FILE in ${FILES}; do
#            /tmp/unpack.sh "${FILE}" || true
#          done

      - name: Add files, commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: ${{ env.BRANCH_NAME }}
          create_branch: true
          push_options: '--force'
